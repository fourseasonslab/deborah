<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>deborah</title>
<script src="/socket.io/socket.io.js"></script>
<script>

onload = function(){
	var spBox = document.getElementById('speechResultBox');
	var rpBox = document.getElementById('responseBox');
	var stBox = document.getElementById('statusBox');
	// Socket.io
	var socket = io(location.protocol + '//' + location.host);
	socket.on('connect', function(){
		console.log("sock: connect");
	});
	socket.on('event', function(data){
		console.log("sock: event");
		console.log(data);
	});
	socket.on('reply', function(data){
		rpBox.innerText = data.text;
		var au = new Audio(data.voiceURL);
		au.play();
	});
	socket.on('disconnect', function(){
		console.log("sock: disconnected");
	});

	// Speech Recognition
	if (!('webkitSpeechRecognition' in window)){
		console.log("webkitSpeechRecognition not found");
		return;
	}
	console.log("webkitSpeechRecognition found");

	var recognition = new webkitSpeechRecognition();
	recognition.continuous = true;
	recognition.interimResults = true;

	var speakButtonDOM = document.getElementById("speakButton");
	speakButtonDOM.onclick = function(){
		recognition.lang = "ja-JP";
		recognition.start();
	};

	recognition.onstart = function(){
		console.log("Recog begin.");
		stBox.innerText = "話してください";
	};

	recognition.onend = function(){
		console.log("Recog end.");
		stBox.innerText = "startボタンを押してください";
	};

	recognition.onspeechstart = function(){
		console.log("sp begin.");
	};

	recognition.onspeechend = function(){
		console.log("sp end"); 
	};

	recognition.onnomatch = function(){
		console.log("no match"); 
	};

	recognition.onerror = function(){
		console.log("error"); 
	};

	recognition.onresult = function(e){
		console.log("result");
		//console.log(e);
		var results = e.results;
		console.log(results);
		for(var i = e.resultIndex; i<results.length; i++){
			if(results[i].isFinal){
				var confidence = results[i][0].confidence;
				console.log("" + confidence + ">> " + results[i][0].transcript);
				var postData = {
					type: 'speech',
					confidence: confidence,
					text: results[i][0].transcript
				};
				console.log(socket);
				socket.emit("input", postData);
				spBox.innerText = results[i][0].transcript;
				spBox.style.color = "#00ff00";
			} else{
				console.log(results[i][0].transcript);
				spBox.innerText = results[i][0].transcript;
				spBox.style.color = "#cc0000";
			}
		}
	};
	stBox.innerText = "startボタンを押してください";
}

</script>
<style>
#statusBox {
	height: 32px;
	width: 100%;
	font-size: 16px;
	border: solid 2px #ccffcc;
}

#speechResultBox {
	height: 64px;
	width: 100%;
	font-size: 32px;
	border: solid 2px #c0ffee;
}

#responseBox {
	height: 64px;
	width: 100%;
	font-size: 32px;
	border: solid 2px #ffeec0;
}
</style>
</head>
<body>

<div id="statusBox"></div>
<div id="speechResultBox"></div>
<div id="responseBox"></div>

<button id="speakButton">start</button>
</body>
</html>
