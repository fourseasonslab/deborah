<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>deborah</title>
<script src="/socket.io/socket.io.js"></script>
<script>

function log(s)
{
	var logBox = document.getElementById('logBox');

	logBox.innerText = s + "\n" + logBox.innerText;
}

onload = function(){
	var spBox = document.getElementById('speechResultBox');
	var rpBox = document.getElementById('responseBox');
	var stBox = document.getElementById('statusBox');
	var logBox = document.getElementById('logBox');

	// Socket.io
	var socket = io(location.protocol + '//' + location.host);
	socket.on('connect', function(){
		console.log("sock: connect");
	});
	socket.on('event', function(data){
		console.log("sock: event");
		console.log(data);
	});
	socket.on('reply', function(data){
		rpBox.innerText = data.text;
		log("response: " + data.text);
		var au = new Audio(data.voiceURL);
		au.play();
	});
	socket.on('disconnect', function(){
		console.log("sock: disconnected");
	});

	// Speech Recognition
	if (!('webkitSpeechRecognition' in window)){
		console.log("webkitSpeechRecognition not found");
		log("webkitSpeechRecognition not found");
		return;
	}
	console.log("webkitSpeechRecognition found");
	log("webkitSpeechRecognition found");

	var recognition = new webkitSpeechRecognition();
	recognition.continuous = true;
	recognition.interimResults = true;

	var speakButtonDOM = document.getElementById("speakButton");
	speakButtonDOM.onclick = function(){
		recognition.lang = "ja-JP";
		recognition.start();
	};

	var stopButtonDOM = document.getElementById("stopButton");
	stopButtonDOM.onclick = function(){
		recognition.stop();
	};

	recognition.onstart = function(){
		console.log("Recog begin.");
		log("Recog Begin");
		stBox.innerText = "話してください";
	};

	recognition.onend = function(){
		console.log("Recog end.");
		log("Recog End");
		stBox.innerText = "startボタンを押してください";
	};

	recognition.onspeechstart = function(){
		console.log("sp begin.");
	};

	recognition.onspeechend = function(){
		console.log("sp end"); 
	};

	recognition.onnomatch = function(){
		console.log("no match"); 
	};

	recognition.onerror = function(){
		console.log("error"); 
	};

	recognition.onresult = function(e){
		console.log("result");
		//console.log(e);
		var results = e.results;
		console.log(results);
		for(var i = e.resultIndex; i<results.length; i++){
			if(results[i].isFinal){
				var confidence = results[i][0].confidence;
				var text = results[i][0].transcript;
				console.log("" + confidence + ">> " + text);
				log("result: " + text);
				var postData = {
					type: 'speech',
					confidence: confidence,
					text: text
				};
				console.log(socket);
				socket.emit("input", postData);
				spBox.innerText = text;
				spBox.style.color = "#00ff00";
			} else{
				console.log(results[i][0].transcript);
				spBox.innerText = results[i][0].transcript;
				spBox.style.color = "#cc0000";
			}
		}
	};
	stBox.innerText = "startボタンを押してください";
	
	// Manual input
	var manualInput = document.getElementById("manualInput");
	var manualSendButton = document.getElementById("manualSend");
	manualSendButton.onclick = function(){
		log("manual input : " + manualInput.value);
		var postData = {
			type: 'manual',
			confidence: 1,
			text: manualInput.value
		};
		socket.emit("input", postData);
		manualInput.value = "";
	}
}

</script>
<style>

#speechResultBox {
	height: 64px;
	width: 100%;
	font-size: 32px;
	border: solid 2px #c0ffee;
}

#responseBox {
	height: 64px;
	width: 100%;
	font-size: 32px;
	border: solid 2px #ffeec0;
}
</style>
</head>
<body>
<h2>Deborah web interface</h2>
<h3>voice input</h3>
<div id="statusBox"></div>
<div id="speechResultBox"></div>
<div id="responseBox"></div>
<div id="controlBox">
	<button id="speakButton">start</button>
	<button id="stopButton">stop/send</button>
</div>
<h3>manual input</h3>
<div id="manualBox">
	<input id="manualInput" type="text" style="width: 80%"></input>
	<button id="manualSend">send</button>
</div>
<h3>log</h3>
<div id="logBox">

</div>

</body>
</html>
